steps:
  - command: |
      git config --global --add safe.directory /workdir
      bundle install
      bundle exec buildkite-builder preview rails-ci > .buildkite/pipeline.yml
    label: ":pipeline: buildkite-builder preview rails-ci"
    key: generate-pipeline
    plugins:
      - docker#v5.8.0:
          image: "ruby:latest"
          mount-buildkite-agent: true
          propagate-environment: true
          environment:
            - BUNDLE_GEMFILE=.buildkite/Gemfile
            - BUILD_QUEUE
            - DOCKER_IMAGE
            - RUN_QUEUE
            - QUEUE
      - artifacts#v1.2.0:
          download:
            - ".buildkite/*"
            - ".buildkite/**/*"
          upload:
            - ".buildkite/pipeline.yml"
    timeout_in_minutes: 5
    agents:
      queue: "default"
  - command: |
      pip install check-jsonschema
      check-jsonschema --builtin-schema vendor.buildkite .buildkite/pipeline.yml
    label: ":pipeline: check-jsonschema pipeline.yml"
    depends_on: generate-pipeline
    soft_fail: true
    key: lint-pipeline
    plugins:
      - docker#v5.8.0:
          image: "python:3"
      - artifacts#v1.2.0:
          download:
            - ".buildkite/pipeline.yml"
    timeout_in_minutes: 5
    agents:
      queue: "default"
  - command: |
      git config --global --add safe.directory /workdir
      bundle install
      bundle exec buildkite-builder run rails-ci
    label: ":pipeline: buildkite-builder run rails-ci"
    depends_on: lint-pipeline
    key: run-pipeline
    plugins:
      - docker#v5.8.0:
          image: "ruby:latest"
          mount-buildkite-agent: true
          propagate-environment: true
          environment:
            - BUNDLE_GEMFILE=.buildkite/Gemfile
            - BUILD_QUEUE
            - DOCKER_IMAGE
            - RUN_QUEUE
            - QUEUE
      - artifacts#v1.2.0:
          download:
            - ".buildkite/*"
            - ".buildkite/**/*"
    timeout_in_minutes: 5
    agents:
      queue: "default"