# This file is never read -- it's just a copy of the pipeline's
# configuration in the Buildkite UI.

steps:
  - name: ":pipeline: fetch config repo and upload pipeline"
    command: |
      PATH=/bin:/usr/bin
      set -e
      treesha="$$(git ls-tree -d HEAD .buildkite | awk '{print $$3}')"
      echo "+++ No .buildkite/; using fallback repository"
      rm -rf .buildkite

      if [ -n "$$CONFIG_REPO" ]; then
        echo "Using CONFIG_REPO: $$CONFIG_REPO"
        GIT_REPO="$$CONFIG_REPO"
      elif [ -n "$$CONFIG_FORK" ]; then
        echo "Using CONFIG_FORK: $$CONFIG_FORK"
        GIT_REPO="https://github.com/$$CONFIG_FORK/buildkite-config"
      else
        echo "Using fallback upstream repo..."
        GIT_REPO="https://github.com/rails/buildkite-config"
      fi

      GIT_BRANCH="$${CONFIG_BRANCH-main}"
      GIT_BRANCH="$${GIT_BRANCH#*:}"

      echo "git clone -b \"$$GIT_BRANCH\" \"$$GIT_REPO\" .buildkite"
      git clone -b "$$GIT_BRANCH" "$$GIT_REPO" .buildkite

      rm -rf .buildkite/.git
      buildkite-agent pipeline upload <<'NESTED'
      steps:
        - command: |
            git config --global --add safe.directory /workdir
            bundle install
            bundle exec buildkite-builder preview rails-ci > .buildkite/pipeline.yml
            bundle exec buildkite-builder run rails-ci
          label: ":pipeline: buildkite-builder run rails-ci"
          key: generate-pipeline
          plugins:
            - docker#v5.8.0:
                image: "ruby:latest"
                mount-buildkite-agent: true
                propagate-environment: true
                environment:
                  - BUNDLE_GEMFILE=.buildkite/Gemfile
                  - BUILD_QUEUE
                  - DOCKER_IMAGE
                  - RUN_QUEUE
                  - QUEUE
            - artifacts#v1.2.0:
                download:
                  - ".buildkite/*"
                  - ".buildkite/**/*"
                upload:
                  - ".buildkite/pipeline.yml"
          timeout_in_minutes: 5
          agents:
            queue: "default"
      NESTED

      ([ -f .buildkite/.dockerignore ] && cp .buildkite/.dockerignore .dockerignore) || true
    plugins:
      - artifacts#v1.2.0:
          upload: [".buildkite/**/*", ".buildkite/pipelines", ".dockerignore"]
    timeout_in_minutes: 5
    agents:
      queue: "default"